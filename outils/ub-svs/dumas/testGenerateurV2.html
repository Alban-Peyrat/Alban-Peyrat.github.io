<!DOCTYPE html>
<html>
<head>
    <title>Alban Peyrat - Générateur de notice bibliographique d'une thèse d'exercice déposée sur DUMAS (BU SVS)</title>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="https://alban-peyrat.github.io/ico_logo_AP.png"/>
    <link rel="stylesheet" href="https://alban-peyrat.github.io/gh-pages.css"/>
<!--
Source des données :
- HAL (DUMAS)
- Agence bibliographique de l'Enseignement supérieur
- Wikidata

Bibliothèque JS utilisée pour la rétrocompatibilité avec IE : babeljs
(lien vers la doc sur le CDN : https://babeljs.io/docs/en/babel-standalone)
-->
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
<input type="text" id="inputURL" placeholder="Collez l'adresse DUMAS de la thèse" style="color:black;">
<button id="generate" style="color:black;">Générer la notice</button>
<!-- <label><input id="enhanced606" type="checkbox">Chercher PPN sujet RAMEAU</input></label>
<label><input id="enhancedAut" type="checkbox">Chercher PPN auteur(s)</input></label>
<label><input id="enhancedDir" type="checkbox">Chercher PPN directeur(s) de thsèe</input></label> -->
<input id="enhanced606" type="checkbox"><label for="enhanced606">Chercher PPN sujet RAMEAU</label>
<input id="enhancedAut" type="checkbox"><label for="enhancedAut">Chercher PPN auteur(s)</label>
<input id="enhancedDir" type="checkbox"><label for="enhancedDir">Chercher PPN directeur(s) de thsèe</label>
<div id="notice">
</div>
</body>
<script type="text/babel">

document.getElementById("generate").onclick = function() {
//l'idée c'est que cette opération se fasse dans generate
//asyncMain(document.getElementById("inputURL").value);
    let inputURL = document.getElementById("inputURL").value.trim();
    let docId = inputURL.substring(inputURL.length - 8);
    main(docId);
}

//Charge le JSON contenant les index DUMAS
//Source originale : https://codepen.io/KryptoniteDove/post/load-json-file-locally-using-pure-javascript [23/11/2021]
function loadDumasJson(callback) {   
    var xobj = new XMLHttpRequest();
    xobj.overrideMimeType("application/json");
    xobj.open("GET", "https://alban-peyrat.github.io/outils/ub-svs/dumas/dumas_indexes.json", true); // Replace "my_data" with the path to your file
    xobj.onreadystatechange = function () {
        if (xobj.readyState == 4 && xobj.status == "200") {
        // Required use of an anonymous callback as .open will NOT return a value but simply returns undefined in asynchronous mode
            callback(xobj.responseText);
        }
    };
    xobj.send(null);  
}
loadDumasJson(function(response) {dumasIndexJson = JSON.parse(response)});

function main(docId){

    var URLThese = "https://api.archives-ouvertes.fr/search/dumas/?q=docid:"+docId+"&wt=json&fl=language_s,title_s,authFirstName_s,authLastName_s,uri_s,director_s,keyword_s,uri_s,abstract_s,page_s,dumas_degreeSpeciality_s,publicationDateY_i,dumas_degreeType_s";

//Accède au JSON
//Source originale : https://zetcode.com/javascript/jsonurl/ [22/11/2021]
    var getJSON = function(url, callback) {

        var xhr = new XMLHttpRequest();
        xhr.open("GET", url, true);
        xhr.responseType = "json";

        xhr.onload = function() {

            var status = xhr.status;

            if (status == 200) {
                callback(null, xhr.response);
            } else {
                callback(status);
            }
        };

        xhr.send();
    };

    getJSON(URLThese,  function(err, data) {

        if (err != null) {
            console.error(err);
        } else {
            analyseJSON(data);
        }
    });


    function analyseJSON(data){
        if(typeof data === "string"){
            data = JSON.parse(data);
        }
        let doc = data.response.docs[0];
        let enhanced606 = document.getElementById("enhanced606").checked;
        let enhancedAut = document.getElementById("enhancedAut").checked;
        let enhancedDir = document.getElementById("enhancedDir").checked;
//-------------------- Données codées --------------------
        notice = "008 $aOax3\n";
//NNT
        if(doc.hasOwnProperty("publicationDateY_i") === true){
            annee = doc.publicationDateY_i;
        }else{
            annee = ";_;ERREUR-002;_;";
        };
        if(doc.hasOwnProperty("dumas_degreeSpeciality_s") === true){
            codeSpe = doc.dumas_degreeSpeciality_s[0];
        }else{
            codeSpe = "empty";
        };
        if(doc.hasOwnProperty("dumas_degreeType_s") === true){
            codeType = doc.dumas_degreeType_s[0];
        }else{
            codeType = ";_;ERREUR-003;_;";
        };
        specialityCodeToUNM();
        notice += "_MOD_029 ##$aFR$b"+annee+"BORD"+domaineCode+"XXX\n";

        notice += "100 0#$a"+annee+"\n";

//Langue 101
        let langue = langToCoded(doc.language_s[0]);
        notice += "101 0#$a"+langue+"$c"+langue+"$d"+langue+"$g"+langue+"\n";

        notice += "102 ##$aFR\n";
        notice += "104 ##$ak$by$cy$dba$e0$ffre\n";
        notice += "105 ##$ay$bm$ba$c0$d0$e0$fy$gy\n";
        notice += "135 ##$ad$br\n";
        notice += "181 ##$P01$ctxt\n";
        notice += "182 ##$P01$cc\n";
        notice += "183 ##$P01$aceb\n";
//-------------------- 2XX --------------------
//Titre 200
        notice += "_VER_200 1#$a" + titleToUNM(doc.title_s[0]);

//Auteur 200
        if(doc.authFirstName_s.length > 1){
            notice += "$f" + doc.authFirstName_s[0] + " " + doc.authLastName_s[0]
        }else{
            notice += "$f" + doc.authFirstName_s[0] + " " + doc.authLastName_s[0]
        }

//Directeur de thèse 200
        notice += "$gsous la direction de " + doc.director_s[0] + "\n";

//Année de publication 214
        notice += "214 #1$a" + annee + "\n";

        notice += "230 ##$aDonnées textuelles\n";

//-------------------- 3XX --------------------
        notice += "303 ##$aL'impression du document génère "+doc.page_s+" f.\n";
        notice += "_MOD_310 ##$aThèse sous embargo jusqu'au JOUR/MOIS/ANNÉE\n";
        notice += "_MOD_320 ##$aBibliogr. XX réf. Annexes\n";
        notice += "328 #0$bThèse d'exercice$c"+domaine+specialite+"$eBordeaux$d"+annee+"\n";

//Résumés 330
        for (let ii = 0; ii < doc.abstract_s.length; ii++){
        notice += "330 ##$a"+doc.abstract_s[ii]+"\n";
        }

//-------------------- 4XX - 5XX - 6XX --------------------
//Titre anglais
        if(doc.title_s.length > 0){
            notice += "541 ##$a" + titleToUNM(doc.title_s[1])+"$zeng\n";
        }

//Sujets
        for(let ii = 0; ii < doc.keyword_s.length; ii++){
        notice += "_DEL_610 0#$a" + doc.keyword_s[ii]+"\n";
        }

        notice += "608 ##$3027253139$2rameau\n"

//-------------------- 7XX - 8XX --------------------
//auteurs 70X $4070
        for(let ii = 0; ii < doc.authLastName_s.length; ii++){
        notice += "700 #1$a" + doc.authLastName_s[ii]+"$b" + doc.authFirstName_s[ii]+"$4070\n";
        }

//Directeur de thèse
        for(let ii = 0; ii < doc.director_s.length; ii++){
            notice += "701 #1$a" + doc.director_s[ii]+"$4727\n";
        }

        notice += "711 02$3175206562$4295\n"
        notice += "856 4#$qPDF$u"+doc.uri_s+"$2Accès au texte intégral"

//Output
        document.getElementById("notice").innerText = notice;
    }



};





//Version 2

//-------------------Lance le script pour l'interface web-------------------
// document.getElementById("generate").onclick = function() {
//     asyncMain(document.getElementById("inputURL").value);
// }

//--------------------Initialisation des var globales--------------------
var notice = "";//useless prbly
var dumasIndexJson;//useless prbly
var annee, domaine, domaineCode, codeType, specialite, codeSpe, langue, langue2;//A MOD

//--------------------Fonctions--------------------
//Fonction renvoyant le JSON à l'adresse indiquée
function getJSONData (urlJSON) {
  return new Promise(function(resolve){
    //Accède au JSON
    //Source originale : https://zetcode.com/javascript/jsonurl/ [22/11/2021]
        function getJSON(url, callback) {

            let xhr = new XMLHttpRequest();
            xhr.open("GET", url, true);
            xhr.responseType = "json";

            xhr.onload = function() {

                var status = xhr.status;

                if (status == 200) {
                    callback(null, xhr.response);
                } else {
                    callback(status);
                }
            };

            xhr.send();
        };

        getJSON(urlJSON,  function(err, data) {
            if (err != null) {
                console.error(err);
            } else {
                resolve(data);
            }
        });
  });
};

//--------------------Transormation de données vers l'UNM--------------------
function titleToUNM(title){
//Ajoute le @
    if(title.substring(0, 6) === "De la "){
        title = title.substring(0, 6) + "@" + title.substring(6);
    }else if(title.substring(0, 5) === "De l'"){
        title = title.substring(0, 5) + "@" + title.substring(5);
    }else if(title.substring(0, 4) === ("Les " || "Des " || "Une " || "The ")){
        title = title.substring(0, 4) + "@" + title.substring(4);
    }else if(title.substring(0, 3) === ("Le " || "La " || "Un " || "An " || "De " || "Du ")){
        title = title.substring(0, 3) + "@" + title.substring(3);
    }else if(title.substring(0, 2) === ("A " || "L'" || "D'")){
        title = title.substring(0, 2) + "@" + title.substring(2);
    }else{
        title = "@" + title;
    }

//Ajoute les $e
    //marche pas sur IE
    //title = title.replaceAll(" : ", "$e");
    //title = title.replaceAll(": ", "$e");
    title = title.replace(/( : )/g, "$e");
    title = title.replace(/(: )/g, "$e");

//Return
    return title;
};

//TEMPORAIRE ||||| transforme la langue DUMAS en langue UNM
function langToCoded(lang){
    switch (lang){
        case "fr":
            return "fre";
            break;
        case "en":
            return "eng"
            break;
        default:
            return "fre"
    };
}

//Prépare le NNT et la 328$c
function specialityCodeToUNM(){
    var degreeSpe = dumasIndexJson.dumasIndexes.dumas_degreeSpeciality;
    //find marche pas sur IE aaaaaaaaah
    //let selectedSpe = degreeSpe.find(function(type){return type.degreeSpecialityCode === codeSpe});
    //Source https://dustinpfister.github.io/2021/07/19/js-array-find/
    let selectedSpe = degreeSpe.filter(function(type){return type.degreeSpecialityCode === codeSpe});
    let speName = selectedSpe[0].degreeSpecialityName;
    
    specialite = "";
    switch (codeType) {
        case "30":
            domaine = "Chirurgie dentaire";
            domaineCode = "O";
            break;
        case "12":
            if(codeSpe === "150"){
                domaine = "Médecine générale";
                domaineCode = "M";
            }else{
                domaine = "Médecine. ";
                domaineCode = "3";
                specialite = speName;
            }
            
            break;
        case "13":
            domaine = "Pharmacie";
            domaineCode = "P"
            if(codeSpe !== "empty"){
                specialite = ". " + speName;
            };                
            break;
        default:
            domaineCode = "?";
            domaine = ";_;ERREUR-001;_;";
    };
}

//--------------------Script principal--------------------
async function asyncMain(inputURL) {
    console.log('==Début séquentiel==');

//Initialisation var
    var unmFields = new Array();

//Isolement du docId
    inputURL = inputURL.trim();
    let docId = inputURL.substring(inputURL.length - 8);

//Récupération des paramètres enhanced
//A MOD c'est plus censé être ça les paramètres
    let enhanced606 = document.getElementById("enhanced606").checked;
    let enhancedAut = document.getElementById("enhancedAut").checked;
    let enhancedDir = document.getElementById("enhancedDir").checked;

//Création des champs fixes
    unmFields.push("008 $aOax3");
    unmFields.push("102 ##$aFR");
    unmFields.push("104 ##$ak$by$cy$dba$e0$ffre");
    unmFields.push("105 ##$ay$bm$ba$c0$d0$e0$fy$gy");
    unmFields.push("135 ##$ad$br");
    unmFields.push("181 ##$P01$ctxt");
    unmFields.push("182 ##$P01$cc");
    unmFields.push("183 ##$P01$aceb");
    unmFields.push("230 ##$aDonnées textuelles");
    unmFields.push("320 MOD ##$aBibliogr. XX réf. Annexes");
    unmFields.push("608 ##$3027253139$2rameau");

//Récupération des métadonnées de la thèse dans DUMAS
    var theseDumasJSON = await getJSONData("https://api.archives-ouvertes.fr/search/dumas/?q=docid:"+docId+"&wt=json&fl=language_s,uri_s,authFirstName_s,authLastName_s,director_s,authStructId_i,dumas_degreeSpeciality_s,dumas_degreeType_s,publicationDateY_i,title_s,keyword_s,abstract_s,page_s,openAccess_bool");
    let doc = theseDumasJSON.response.docs[0];
    console.log(doc);

//Analyse des métadonnées de la thèse dans DUMAS (p. 1)
//-----------Annee
    if(doc.hasOwnProperty("publicationDateY_i") === true){
        annee = doc.publicationDateY_i;
    }else{
        annee = ";_;ERREUR-002;_;";
    };

    unmFields.push("100 0#$a" + annee);
    unmFields.push("214 #1$a" + annee);
    
//----------Domaine + spécialité
    if(doc.hasOwnProperty("dumas_degreeSpeciality_s") === true){
        codeSpe = doc.dumas_degreeSpeciality_s[0];
    }else{
        codeSpe = "empty";
    };
    if(doc.hasOwnProperty("dumas_degreeType_s") === true){
        codeType = doc.dumas_degreeType_s[0];
    }else{
        codeType = ";_;ERREUR-003;_;";
    };
    specialityCodeToUNM();

//Récupération du PPN de la structure
//A MOD
    let univHALId = "";
    let univWikidataId = "";
    let univCodeNNT = "BORD";
    let univLibel328 = "Bordeaux";
    let univPPN = "175206562";
    if(doc.hasOwnProperty("authStructId_i") === true){
        univHALId = doc.authStructId_i[0];
    }else{
        univHALId = ";_;ERREUR-011;_;";
    };

//Code Wikidata modern Javascript
class SPARQLQueryDispatcher {
    constructor( endpoint ) {
        this.endpoint = endpoint;
    }

    query( sparqlQuery ) {
        var fullUrl = this.endpoint + '?query=' + encodeURIComponent( sparqlQuery );
        var headers = { 'Accept': 'application/sparql-results+json' };

        return fetch( fullUrl, { headers } ).then( body => body.json() );
    }
}

var endpointUrl = 'https://query.wikidata.org/sparql';
var sparqlQuery = `SELECT DISTINCT ?item ?itemLabel WHERE {
  SERVICE wikibase:label { bd:serviceParam wikibase:language "[AUTO_LANGUAGE]". }
  {
    SELECT DISTINCT ?item WHERE {
      ?item p:P6773 ?statement0.
      ?statement0 (ps:P6773) "`+univHALId+`".
    }
    LIMIT 100
  }
}`;

var queryDispatcher = new SPARQLQueryDispatcher( endpointUrl );
queryDispatcher.query( sparqlQuery ).then( console.log );
//Fin de code de Wikidata


    let structWikiDataId = "Q13344";
    var structWikiDataJSON = await getJSONData("https://www.wikidata.org/wiki/Special:EntityData/"+structWikiDataId+".json");
    //let ppnStruct = structWikiDataJSON.entities.Q13344.claims.P269[0].mainsnak.datavalue.value;
    let ppnStruct = structWikiDataJSON.entities[structWikiDataId].claims.P269[0].mainsnak.datavalue.value;
    console.log(structWikiDataJSON);
    console.log(ppnStruct)
//Identification Université
//A MOD

    unmFields.push("711 02$"+univPPN+"$4295")

//Analyse des métadonnées de la thèse dans DUMAS (p. 2)
//----------NNT et 328
    unmFields.push("029 MOD ##$aFR$b"+annee+univCodeNNT+domaineCode+"XXX");
    unmFields.push("328 #0$bThèse d'exercice$c"+domaine+specialite+"$e"+univLibel328+"$d"+annee);

//----------Résumé
    if(doc.hasOwnProperty("abstract_s") === true){
        for (let ii = 0; ii < doc.abstract_s.length; ii++){
            unmFields.push("330 ##$a"+doc.abstract_s[ii]);
        }
    }else{
        unmFields.push("330 ##$a;_;ERREUR-005;_;");
    };

//----------Langue
//A MOD la fonction langToCoded
//Ne prend pas en compte les résumés ATM
    if(doc.hasOwnProperty("language_s") === true){
        langue = langToCoded(doc.language_s[0]);
        if(langue === "fre"){
            langue2 = "eng";
        }else{
            langue2 = "fre";
        }
    }else{
        langue = ";_;ERREUR-004;_;";
    };
    if(doc.abstract_s.length > 1){
        unmFields.push("101 0#$a"+langue+"$c"+langue+"$d"+langue+"$d"+langue2+"$g"+langue);
    }else{
        unmFields.push("101 0#$a"+langue+"$c"+langue+"$d"+langue+"$g"+langue);
    }

//-----------Pagination
    if(doc.hasOwnProperty("page_s") === true){
        unmFields.push("303 ##$aL'impression du document génère "+doc.page_s+" f.");
    }else{
        unmFields.push("303 ##$aL'impression du document génère ;_;ERREUR-006;_; f.");
    };

//----------Embargo
    if(doc.hasOwnProperty("openAccess_bool") === true){
        if(doc.openAccess_bool === false){
            unmFields.push("310 MOD ##$aThèse sous embargo jusqu'au JOUR/MOIS/ANNÉE");
        }
    }else{
        unmFields.push("310 MOD ##$aThèse sous embargo jusqu'au ;_;ERREUR-007;_;");
    };

//----------URI
    if(doc.hasOwnProperty("uri_s") === true){
        unmFields.push("856 4#$qPDF$u"+doc.uri_s+"$2Accès au texte intégral");
    }else{
        unmFields.push("856 4#$qPDF$u;_;ERREUR-008;_;$2Accès au texte intégral");
    };

//----------Mots-clefs
//A MOD (enhanced)
    if(doc.hasOwnProperty("keyword_s") === true){
        for(let ii = 0; ii < doc.keyword_s.length; ii++){
            unmFields.push("610 DEL 0#$a" + doc.keyword_s[ii]);
        }
    }else{
        unmFields.push("610 DEL 0#$a;_;ERREUR-009;_;");
    };

//----------Titres et mentions de responsabilité
let unm200;
    if(doc.hasOwnProperty("title_s") === true){
        unm200 = "200 VER 1#$a" + titleToUNM(doc.title_s[0]);
//----------------Deuxième titre (ou plus, mais tous avec la langue n°2)
        for(let ii = 1; ii < doc.title_s.length; ii++){
            unmFields.push("541 ##$a" + titleToUNM(doc.title_s[ii])+"$z"+langue2);
        }
    }else{
        unm200 = "200 VER 1#$a;_;ERREUR-010;_;"
    };

//---------------Auteurs


//---------------Directeurs de thèse







//Tri et écriture
    unmFields.sort();
    document.getElementById("notice").innerText = "";
    for(let ii=0; ii<unmFields.length; ii++){
        document.getElementById("notice").innerText += unmFields[ii]+"\n";
    }
}

//A SUP
//Lance le script quand je charge la page (accelere le dvpment)
asyncMain("https://dumas.ccsd.cnrs.fr/dumas-03076389");

//utiliser la biblitohèque https://babeljs.io/ parce que bon IE ça soule
</script>
</html>
